name: ðŸ“¦ CI - Builds

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  registry:
    name: ðŸ“¦ Build, Package, and ship to GitHub Registry
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-latest

    steps:
      - name: ðŸŽ¬ Check out Git repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: ðŸ·ï¸ Get the version
        id: get_version
        run: echo "VERSION=$(node -e "console.log(require('./package.json').version)")" >> $GITHUB_OUTPUT

      - name: ðŸšœ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ” Login to GitHub Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.CR_PAT }}

      - name: ðŸ”” Notify about the start of the building process...
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          VERSION: v${{ steps.get_version.outputs.VERSION }}
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload-file-path: "./.github/resources/slack-builds-start.json"

      - name: ðŸ³ Push Gateway to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/gateway"
          push: true
          tags: |
            ghcr.io/turnly/gateway:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/gateway:latest

      - name: ðŸ³ Push Addons to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/addons"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/addons:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/addons:latest

      - name: ðŸ³ Push Assistance Centers to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/assistance-centers"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/assistance-centers:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/assistance-centers:latest

      - name: ðŸ³ Push Business Owners to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/business-owners"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/business-owners:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/business-owners:latest

      - name: ðŸ³ Push Custom Fields to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/custom-fields"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/custom-fields:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/custom-fields:latest

      - name: ðŸ³ Push Helpdesk API to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/helpdesk-api"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/helpdesk-api:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/helpdesk-api:latest

      - name: ðŸ³ Push IAM to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/iam"
          push: true
          tags: |
            ghcr.io/turnly/iam:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/iam:latest

      - name: ðŸ³ Push OAuth Middleware to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/oauth"
          push: true
          tags: |
            ghcr.io/turnly/oauth:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/oauth:latest

      - name: ðŸ³ Push Platform Realtime API to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/platform-realtime-api"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/platform-realtime-api:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/platform-realtime-api:latest

      - name: ðŸ³ Push Queuing System to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/queuing-system"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/queuing-system:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/queuing-system:latest

      - name: ðŸ³ Push Teams to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/teams"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/teams:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/teams:latest

      - name: ðŸ³ Push Widgets API to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/widgets-api"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/widgets-api:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/widgets-api:latest

      - name: ðŸ³ Push Widgets Realtime API to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./apps/widgets-realtime-api"
          target: production
          push: true
          tags: |
            ghcr.io/turnly/widgets-realtime-api:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/widgets-realtime-api:latest

      - name: ðŸ³ Push Fluentd to GitHub Registry
        uses: docker/build-push-action@v3
        with:
          context: "./.devo/provisioning/infrastructure/observability/fluentd"
          push: true
          tags: |
            ghcr.io/turnly/fluentd:v${{ steps.get_version.outputs.VERSION }}
            ghcr.io/turnly/fluentd:latest

      - name: ðŸš¨ Set the slack template to notify the failed process
        if: failure()
        run: echo "SLACK_TEMPLATE=./.github/resources/slack-builds-failed.json" >> $GITHUB_ENV

      - name: âœ… Set the slack template to notify successful completion
        if: success()
        run: echo "SLACK_TEMPLATE=./.github/resources/slack-builds-success.json" >> $GITHUB_ENV

      - name: ðŸ”” Notifying the Engineering team...
        if: always()
        uses: slackapi/slack-github-action@v1.23.0
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          VERSION: v${{ steps.get_version.outputs.VERSION }}
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
          payload-file-path: ${{ env.SLACK_TEMPLATE }}
